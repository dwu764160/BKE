
Project Context Summary — Offensive Archetypes v4 (auto-updated)
=================================================================

Purpose
-------
- This file captures the complete, project-relevant context from recent development on the offensive archetypes system (v1 → v2 → v3 → v4), viewer updates, data artifacts, and validation runs. Keep this file updated whenever you or an agent encounter important facts, thresholds, decisions, or outputs that affect classification logic, viewer behavior, or downstream evaluation.

Important Paths
---------------
- Workspace root: /mnt/c/Users/danie/OneDrive/Documents/BKE
- Main scripts and artifacts:
	- `src/data_compute/compute_player_archetypes.py` — v3 classification engine (percentile-based)
	- `app/player_archetype_viewer.py` — viewer generator (HTML + JS template)
	- `app/player_archetypes.html` — generated interactive viewer (open in browser)
	- `data/processed/player_archetypes.parquet` — latest classification output (1680 player-seasons)
	- `reference/player_offensive_archetypes.md` — v3 documentation (rewritten)
	- `loop/context_summary.txt` — this file (source of truth for session-level knowledge)
	- `/tmp/write_v3.py`, `/tmp/patch_v3.py`, `/tmp/patch_v3b.py` — generator/patch scripts used during development (kept as artifacts)

High-level Goals (from user)
----------------------------
1. Convert many static thresholds into percentile-based gates so the system remains valid across seasons.
2. Tighten Ball Dominant Creator (BDC) and All-Around Scorer pools to retain roughly 40–60% of prior sizes (aim ≤60% retention of BDCs).
3. Add BDC subtypes: Heliocentric Guard, Post Hub, Gravity Engine (priority ordering and robust gating).
4. Split PnR Big into PnR Rolling vs PnR Popping (based on FG3A per-36 relative to season median).
5. Treat computed USG% as a soft signal only (do not use as a hard gate).
6. Improve Connector by adding touches / sec-per-touch filters so only active creators are captured.
7. Relax Movement Shooter rule to movement/(movement+spotup) >= 0.4 instead of strictly movement > spotup.
8. Convert FG2A_RATE thresholds to percentiles (P70 for interior, P30 for perimeter) instead of hard 0.70/0.45.
9. Split a single confidence metric into `role_confidence` (fit) and `role_effectiveness` (production quality).
10. Keep the whole system reproducible and documented; provide viewer & docs updates.

Summary of Key Work Completed
-----------------------------
- Percentile computation implemented: `PCTILE_THRESHOLDS` (mapping threshold name -> (column, percentile)); `compute_season_percentiles()` resolves values per season from qualified players.
- New static constants placed under `STATIC` where percentiles are inappropriate (e.g., `MIN_MINUTES`, `POST_WEIGHT`, `HELIOCENTRIC_ON_BALL`, `POST_HUB_POSS`, `MOVEMENT_RATIO_MIN`, `CONNECTOR_SEC_PER_TOUCH_MAX`).
- v3 classification engine implemented in `src/data_compute/compute_player_archetypes.py` (written using `/tmp/write_v3.py` then patched with patch scripts):
	- BDC main path: requires ball_dom >= P80, AST >= P75, PTS >= P50, and composite >= 0.35 (composite uses linear interpolation from threshold → P95; 60% volume / 40% playmaking).
	- BDC subtypes priority: Post Hub (dominant/relative), Gravity Engine (high 3PA+eff), Heliocentric Guard (very high ball_dom P85), Primary Scorer fallback.
	- Hub (elite playmaker + elite scorer) applies the same subtype logic; additional Playmaking Hub sub-path (elite AST + POST >= 0.10, catches Sabonis).
	- Ballhandler: high playmaking, not high scorer.
	- Primary Scorers: ball_dom >= P60; FG2A percentile gating for interior/perimeter/all-around; All-Around requires pts >= P60 to reduce false positives.
	- Connector: AST >= P50 with activity filter (touches >= P50 OR sec-per-touch <= 2.5) and extra secondary-ast signals.
	- PnR Big: PRROLLMAN >= P70, choose Popping vs Rolling by FG3A >= P50 (median).
	- Off-Ball Finisher: CUT+PRROLL ≥ P75 or finish_score > 0.20.
	- Movement Shooter: movement >= P70 AND movement/(movement+spotup) >= 0.40.
	- Stationary Shooter: spotup >= P50.
	- Rotation Piece: catch-all.

Key Implementation Details
------------------------
- Composite calculation for BDC uses linear interpolation from floor (threshold) to P95 for ball_dom, scoring (PTS), and AST. This provides discrimination between borderline and elite players.
- `role_confidence` is fit (0–1) and typically derived from sqrt or normalized interpolations depending on archetype; `role_effectiveness` is a weighted function of TS z-score, volume (PTS/36), and relevant PPPs.
- USG is computed as a proxy when missing but only used as a soft signal. It is not a disqualifier.
- Movement Shooter ratio changed to movement/(movement+spotup) >= 0.4.
- FG2A_RATE is used via season percentiles: interior P70 / perimeter P30.

Representative 2024-25 Percentile Values (resolved during the run)
----------------------------------------------------------------
(These are per `compute_season_percentiles()` for qualified players; include as historic reference)
- BD_MIN (P80): 0.3720
- PLAYMAKER (AST_PER36 P75): 5.0741
- HIGH_SCORING (PTS_PER36 P70): 18.95
- FG2A_INTERIOR (P70): 0.6731
- FG2A_PERIMETER (P30): 0.4781
- CONNECTOR_AST (P50): 3.3759
- ALL_AROUND_SCORING (P60): 17.2264
- HIGH_PRROLLMAN (P70): 0.0646
- FG3A_MEDIAN (P50): 5.8126
- TOUCHES_MEDIAN (P50): 40.3
- HIGH_FG3A (P80): ~8.017

Distribution & Validation (2024-25 qualified players)
--------------------------------------------------
- Qualified: 329 players (MIN ≥ 500, GP ≥ 20, MPG ≥ 15)
- Archetype counts (v3 run):
	- Off-Ball Stationary Shooter: 64 (19.5%)
	- Off-Ball Finisher: 62 (18.8%)
	- Ball Dominant Creator: 40 (12.2%)
	- Ballhandler: 31 (9.4%)
	- Connector: 28 (8.5%)
	- All-Around Scorer: 26 (7.9%)
	- PnR Rolling Big: 21 (6.4%)
	- Interior Scorer: 18 (5.5%)
	- Off-Ball Movement Shooter: 17 (5.2%)
	- Rotation Piece: 10 (3.0%)
	- Perimeter Scorer: 7 (2.1%)
	- PnR Popping Big: 5 (1.5%)

Subtype counts (examples): Transition Player 45, High Volume 33, Heliocentric Guard 29, Gravity Engine 6, Post Hub 2.

Notable Player Classifications (validated)
-----------------------------------------
- LeBron James → Ball Dominant Creator / Heliocentric Guard (conf ~100%, eff ~85%)
- Stephen Curry → Ball Dominant Creator / Gravity Engine (100%, ~86%)
- Nikola Jokić → Ball Dominant Creator / Post Hub (100%, ~98%)
- Domantas Sabonis → Ball Dominant Creator / Post Hub (96%, ~95%)
- Luka Dončić → Ball Dominant Creator / Heliocentric Guard (100%, ~85%)
- Tyrese Haliburton → Ball Dominant Creator / Gravity Engine (100%, ~88%)
- Kevin Durant → All-Around Scorer / High Volume (100%, ~92%)
- Anthony Edwards → All-Around Scorer / High Volume (100%, ~80%)
- Brook Lopez → PnR Rolling Big (100%, ~82%)
- Many others validated; full list printed during run.

Viewer Updates
--------------
- `app/player_archetype_viewer.py` updated to show `Fit: X% · Eff: Y%` by:
	- Adding `off_effectiveness` to the player dict (p.off_effectiveness derived from `role_effectiveness` scaled to percent).
	- Replacing the old confidence template snippet with `Fit: ${p.off_confidence}% · Eff: ${p.off_effectiveness}%${p.off_secondary ? ' · ' + p.off_secondary : ''}`.
	- Adding new sort button labels: `Fit` and `Effectiveness` to allow client-side sorting by either metric.
- HTML regenerated: `app/player_archetypes.html` created/updated and contains references to `off_effectiveness` and PnR archetypes. Note: client-side JS renders template literals; grep for literal strings like `Fit:` may not show in server-side file counts.

Bugs/Issues Encountered & Fixes
--------------------------------
- Unicode middot (·, U+00B7) in the template prevented naive search/replace; resolved using exact string replacement and updating the template literal.
- Syntax indentation error in viewer patch (extra blank line before `elif`) — fixed by correcting indentation.
- `POST_HUB_POSS` had a unicode arrow in an earlier comment which caused a KeyError during string matching in patches; fixed by avoiding matching on the arrow and replacing a shorter safe substring.
- v3 code was initially present only in `/tmp` scripts; `write_v3.py` used to persist the v3 file at `src/data_compute/compute_player_archetypes.py`, then patches applied (`patch_v3.py`, `patch_v3b.py`/fixed).

Commands & Tools Used (repro)
----------------------------
Run classifier (v3) and regenerate parquet:
```bash
.venv/bin/python src/data_compute/compute_player_archetypes.py
```

Generate viewer HTML:
```bash
.venv/bin/python app/player_archetype_viewer.py
```

Check python syntax:
```bash
.venv/bin/python -m py_compile src/data_compute/compute_player_archetypes.py
.venv/bin/python -m py_compile app/player_archetype_viewer.py
```

Quick verification script used during this session:
```bash
.venv/bin/python /tmp/final_verify.py
```

Files you should version-control (recommended)
-------------------------------------------
- `src/data_compute/compute_player_archetypes.py` (v3 source)
- `app/player_archetype_viewer.py` (viewer generator)
- `reference/player_offensive_archetypes.md` (documentation)
- `/tmp/write_v3.py`, `/tmp/patch_v3.py`, `/tmp/patch_v3b_fixed.py` (developer artifacts — consider moving into `scripts/` if you want to reuse)

Pending / Future Work
---------------------
- Small tuning: BDC retention target aimed ≤60% but actual is ~61.5% (40/65 → 61.5%); acceptable but can be tuned further by adjusting BD_MIN (P80→P85) or composite threshold.
- Add unit tests and CI checks for: percentile resolver, composite interpolation, key player expectations, and viewer HTML generation.
- Update `reference/player_offensive_archetypes.md` further with more examples and the exact per-season percentile table output for each run (optionally commit snapshot tables).
- Add a small CLI or Makefile to: (1) run classifier, (2) regenerate viewer, (3) open HTML in the system browser (for convenience).
- Consider moving the `/tmp` generator/patch scripts into a `dev_tools/` or `scripts/` folder and adding usage notes.

How to keep this file updated
-----------------------------
- Purpose: this is the single-session/ongoing context summary; append important discoveries, thresholds, distribution changes, and decision justifications here.
- When you or the agent: change classification logic, re-tune percentiles, fix viewer templates, or regenerate `player_archetypes.parquet`, add a short entry with date-stamped notes including:
	- What changed (file & lines),
	- Why it changed (bugfix, tuning, design decision),
	- Impact on outputs (counts, key players),
	- Commands to reproduce.
- Use the following template for additions (append to the end of this file):
```
- YYYY-MM-DD — Short title
	- Files changed: path(s)
	- Summary: what & why
	- Repro commands:
		```bash
		# commands
		```
	- Observed impact:
```

Session History (high level)
---------------------------
- v1 → v2: fixed INTERIOR_RATIO, USG/TS NaN handling, playtype & per-36 normalization, initial archetype layout.
- v2 → v3 (this session): implemented percentile thresholds, BDC subtypes, composite interpolation, PnR Big split, connector filters, movement shooter relax, dual confidence, regenerated parquet, updated viewer and docs.

Contact / Ownership
-------------------
- Primary developer: you (workspace owner). The repository contains recorded scripts and the v3 compute script. Use this file as the first place to look for session-specific rationales.

End of summary (last updated: 2026-02-07)

Note: Update this file whenever you encounter important changes to thresholds, classification rules, viewer templates, or data artifacts. Add date-stamped entries using the template above.

- 2026-02-07 — Archetype v3 incremental updates / 3.5 prep
	- Files changed: src/data_compute/compute_player_archetypes.py, app/player_archetype_viewer.py, app/player_archetypes.html, data/processed/player_archetypes.parquet
	- Summary: 
		- Viewer: Added explicit `PnR Rolling Big` and `PnR Popping Big` filter/options and updated human-readable reasons to reference percentile-based decisions (v3 language).
		- Classification: Confirmed v3 percentile-based thresholds are active (`PCTILE_THRESHOLDS` + `compute_season_percentiles()`); `role_confidence` (fit) and `role_effectiveness` (production) present in output. Regenerated `player_archetypes.parquet` and `player_archetypes.html`.
		- Rotation Piece analysis: Performed a cascade trace for all Rotation Piece players (25 total across 2022-25). Identified three root causes that allow stars to fall into `Rotation Piece`:
			1. Players who are both playmakers and high scorers are excluded by mutually-exclusive gates (BDC requires composite, Hub requires ELITE thresholds, Ballhandler excludes high scorers).
			2. All-Around Scorer requires P60 scoring gate which drops some legit mid/high scorers.
			3. Missing/zero playtype data or weak off-ball signals lead to the catch-all assignment.
		- Short proposal (low-risk changes) to eliminate the Rotation Piece leak:
			1. Add a `is_playmaker && is_high_scorer` path → classify as `All-Around Scorer` before Ballhandler (catches playmaker+scorer cases).
			2. Lower/relax the All-Around scoring gate (P60→P50) or add a fallback All-Around at P50.
			3. Replace the unconditional `Rotation Piece` catch-all with a nearest-fit fallback that assigns the archetype whose normalized distance to its gate is smallest (low confidence), and treat obviously missing playtype rows specially.
		- Midrange / Floater plan: Proposed to fetch shot-zone data (preferred) from NBA shot-zone endpoints (Restricted Area / Paint / Midrange / 3PT zones) and create `MIDRANGE_FREQ` and `AT_RIM_FREQ`. This will allow: (a) a `Midrange Scorer` subtype/archetype, (b) better separation of rim finishers vs midrange specialists (floaters), and (c) more meaningful FG2A usage splits.
	- Repro commands:
		```bash
		# Re-run classifier (v3) and regenerate parquet
		.venv/bin/python src/data_compute/compute_player_archetypes.py
		# Regenerate viewer HTML
		.venv/bin/python app/player_archetype_viewer.py
		# Quick syntax checks
		.venv/bin/python -m py_compile src/data_compute/compute_player_archetypes.py
		.venv/bin/python -m py_compile app/player_archetype_viewer.py
		```
	- Observed impact:
		- Viewer now exposes PnR Rolling/Popping filters and percentile language in player reasons (verified for LeBron, Porziñģis, others).
		- No live regressions observed; HTML regenerated and parquet updated (1680 player-seasons). Rotation Piece count (qualified 2024-25) was 10 — proposed tweaks would reclassify these into concrete archetypes.

- Next steps (recommended):
	- Grand Unified Model: Implement compute_rapm_metrics.py to unify Win Shares, BPM, RAPM outputs into a single EPM-like metric (Layer 3).
	- Add unit tests for v4 classifier: percentile resolver, shot zone merge, key player expectations.
	- Consider adding more midrange/shot zone stats to the viewer cards.

- 2025-06-09 — Archetype v4: Shot zones, Rotation Piece elimination, Midrange Scorer
	- Files changed: src/data_fetch/fetch_shot_zones.py (NEW), src/data_compute/compute_player_archetypes.py (MAJOR), app/player_archetype_viewer.py, app/player_archetypes.html, data/processed/player_archetypes.parquet
	- Summary:
		- NEW: Created `src/data_fetch/fetch_shot_zones.py` — fetches shot zone data from NBA.com `LeagueDashPlayerShotLocations` endpoint (league-wide, single API call per season). Computes AT_RIM_FREQ, MIDRANGE_FREQ, PAINT_FREQ, CORNER3_FREQ, AB3_FREQ, AT_RIM_PLUS_PAINT_FREQ. Saves to `data/tracking/{season}/shot_zones.parquet`.
		- Shot zone data fetched for 3 seasons: 2022-23 (539 players), 2023-24 (572), 2024-25 (569)
		- API response format: `resultSets` is a dict (not list), 6 base columns (PLAYER_ID, PLAYER_NAME, TEAM_ID, TEAM_ABBREVIATION, AGE, NICKNAME), 8 zones × 3 stats (FGM, FGA, FG_PCT) = 30 zone columns
		- Zone prefixes: RA (Restricted Area), PAINT (In The Paint Non-RA), MR (Mid-Range), LC3, RC3, AB3, BC, C3 (Corner 3)
		- v4 classifier changes:
			1. Added 4 new PCTILE_THRESHOLDS: HIGH_AT_RIM (P70), HIGH_MIDRANGE (P70), LOW_MIDRANGE (P30), MODERATE_MIDRANGE (P50)
			2. Added `load_shot_zone_data(season)` and pass to `compute_archetype_features()`
			3. NEW Step 2: All-Around Scorer inserted BEFORE Ballhandler — if playmaker AND high scorer → All-Around Scorer (with Midrange Scorer subtype if high midrange)
			4. Ballhandler moved to Step 3
			5. Interior Scorer subtypes: "Rim Finisher" (AT_RIM_FREQ >= P70), "Midrange Scorer" (MIDRANGE_FREQ >= P50), "High Volume" (fallback)
			6. All-Around gate lowered: uses MODERATE_SCORING (P50) instead of ALL_AROUND_SCORING (P60)
			7. ROTATION PIECE ELIMINATED: Replaced with best-fit fallback scoring each candidate archetype and picking the best match. True last resort uses scoring/defensive signals.
		- Viewer updated: removed Rotation Piece from dropdown, added PnR bigs, added AT_RIM% & MID% to player card stats, updated offensive reasons for new subtypes
	- Validated against key players:
		- DeRozan: Interior Scorer / Midrange Scorer (MR=0.459) ✓
		- Giannis: BD Creator / Offensive Hub (AT_RIM=0.571) ✓ (BD Creator since high ball dominance)
		- Curry: BD Creator / Gravity Engine (all 3 seasons) ✓
		- KD: All-Around / High Volume (2 of 3); Interior Scorer / Midrange Scorer in 23-24 ✓
		- Embiid: Interior Scorer / Midrange Scorer in 22-23; Insufficient Minutes in 24-25 ✓
		- SGA: BD Creator / Heliocentric Guard (all 3) ✓
		- Ant Edwards: All-Around Scorer / High Volume (all 3) ✓
	- Distribution (2024-25 qualified, 329 players):
		- Off-Ball Stationary Shooter: 63 (19.1%)
		- Off-Ball Finisher: 62 (18.8%)
		- All-Around Scorer: 40 (12.2%)
		- Ball Dominant Creator: 40 (12.2%)
		- Connector: 31 (9.4%)
		- Ballhandler: 31 (9.4%)
		- PnR Rolling Big: 20 (6.1%)
		- Interior Scorer: 18 (5.5%)
		- Off-Ball Movement Shooter: 12 (3.6%)
		- Perimeter Scorer: 7 (2.1%)
		- PnR Popping Big: 5 (1.5%)
		- Rotation Piece: 0 (0.0%) ← ELIMINATED
	- Subtype totals (all seasons): Transition Player 98, High Volume 85, Heliocentric Guard 80, Elite Shooter 77, Midrange Scorer 42, Playmaking Big 41, Gravity Engine 19, Rim Finisher 14, Post Hub 7, Primary Scorer 7, Offensive Hub 4, Perimeter Defender 2, Rebounder 1
	- Repro commands:
		```bash
		# Fetch shot zones (one-time, cached)
		.venv/bin/python src/data_fetch/fetch_shot_zones.py
		# Run v4 classifier
		.venv/bin/python src/data_compute/compute_player_archetypes.py
		# Regenerate viewer
		.venv/bin/python app/player_archetype_viewer.py
		```
	- New data files:
		- data/tracking/2022-23/shot_zones.parquet
		- data/tracking/2023-24/shot_zones.parquet
		- data/tracking/2024-25/shot_zones.parquet
		- data/tracking_cache/shot_locations_{season}.json

v4.1 changes (applied 2026-02-07):
	- Alternate Interior Scorer entry path (low BD variant using FG2A + AT_RIM_PLUS_PAINT >= P60)
	- Midrange subtype split: P70+ = Midrange Scorer, P50-P70 = Midrange Lean
	- Frozen FALLBACK_VECTORS for best-fit fallback (prevents feature creep)
	- AT_RIM_PAINT_P60 added to percentile thresholds
	- Validated: Interior Scorer 35→38→37 across seasons; Midrange Lean subtype appearing correctly; all star classifications stable

v4.2 changes (applied 2026-02-07):
	- Skill-finishing gate for Interior Scorer: non-stars must show paint_freq + midrange_freq >= 0.25 (SKILL_FINISHING_MIN). Rim-dependent players (only dunks/layups) fall through to PnR Big / Off-Ball Finisher.
	  - Redirected: Onyeka Okongwu → PnR Rolling Big, Christian Braun → Off-Ball Finisher, Jeremy Sochan → Connector, Jalen Duren → Connector
	- Off-Ball Movement Shooter thresholds loosened: P70→P60, MOVEMENT_RATIO_MIN 0.40→0.30. Captures Tim Hardaway Jr., KCP, Huerter, Moses Moody, Dalton Knecht, etc.
	- New Step 7b: Perimeter Scorer (moderate BD). BD >= P50 + scoring >= P25. Catches self-creating wings (Terry Rozier, Cam Whitmore, Brandon Miller, Derrick White, etc.)
	- Distribution (2024-25): Stationary 64→45 (70%), Movement 12→26, Perimeter 7→14, Interior 37→33, PnR Rolling 12→13
	- All star classifications stable. Viewer regenerated. Markdown docs updated to v4.2.

v4.3 changes (applied 2026-02-07):
	- PnR Big absorption: Added "prominent" path (PRROLLMAN_POSS_PCT >= P50 + interior profile). PnR Roll Man no longer needs to be the MOST COMMON play; as long as it's prominent and the player has an interior profile, they're classified as PnR Big. Also added redirect inside Off-Ball Finisher step for bigs with PnR activity.
	  - Key absorptions: Jarrett Allen, Daniel Gafford → PnR Rolling Big (from Interior Scorer); many bigs from Off-Ball Finisher → PnR Rolling Big
	- Harsher Interior Scorer skill check: SKILL_FINISHING_MIN raised from 0.25 to 0.40. Rim-runners with prominent PnR + low midrange always fall through regardless of scoring volume.
	- "Midrange Lean" subtype renamed to "Inside-the-Arc" everywhere
	- HTML viewer: Added "Reset All" button to clear all filters
	- Archetype Embedding (NEW): Soft role model producing confidence-weighted 11-dimensional embedding vector per player.
	  - Algorithm: (1) compute raw scores for all 11 archetypes using uncapped gate math; (2) convert to confidence via exp(-α·distance); (3) build L1-normalized embedding.
	  - Output: data/processed/archetype_embeddings.parquet (1,680 embeddings), also merged into player_archetypes.parquet.
	  - Derived metrics: emb_entropy (hybrid score), emb_dominance (purity score), emb_entropy_norm (normalized hybrid).
	  - Examples: LeBron 17% dominance/94% hybrid; Curry 43%/75%; Jarrett Allen 35%/48%.
	- Distribution (2024-25): PnR Rolling 13→40, Off-Ball Finisher 54→36, Interior Scorer 33→19, Connector 28→29, Perimeter 14→17
	- All star classifications stable. Reference docs updated to v4.3.
