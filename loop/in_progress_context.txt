DO NOT CHANGE — IN-PROGRESS CONTEXT (Machine-Readable Guidance)

Purpose:
- This file captures the full working context when a model or session encounters difficulty.
- It is intended to be written to by models that are failing on a task so other models can pick up
  where they left off. Do not manually edit this file unless you are coordinating the handoff.

Required Sections (use these headings exactly; other tools rely on them):
1) CONTEXT:
	- Brief summary of the task, current working directory, and any key files or inputs in use.
2) FAILURE_REASON:
	- Short, precise description of why the current attempt failed (errors, unexpected outputs).
3) ATTEMPTED_METHODS:
	- List the strategies, commands, and code changes that were tried (bullet list).
4) SOURCES_READ:
	- Links, files, docs, and commands consulted during troubleshooting.
5) NEXT_STEPS (explicit):
	- One-line actionable items the next agent should attempt, ordered by priority.

Formatting rules for automations:
- Keep each section label (e.g., CONTEXT:) on its own line, followed by content lines.
- Use plain text only — avoid embedding binary, images, or complex markup.
- Keep entries concise; prefer short bullet lists and single-line commands for reproducibility.

Example (template):
CONTEXT:
- Task: run `src/data_compute/audit_win_shares.py`
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_profiles_advanced.parquet

FAILURE_REASON:
- ValueError: ambiguous DataFrame truth value raised at script exit check.

ATTEMPTED_METHODS:
- Added explicit None/empty check in `if __name__ == "__main__"` block.
- Re-ran script under venv; verified output.

SOURCES_READ:
- Local repo files: src/data_compute/audit_win_shares.py

NEXT_STEPS:
- If error recurs, inspect `load_data()` return value and file path accessibility.

DO NOT CHANGE this file format or the section headings; other automated agents rely on them.


---------------------------------------------CONTENTS STARTS HERE-----------------------------------------
CONTEXT:
- Task: Win Shares calculation in `src/data_compute/compute_linear_metrics.py`
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_profiles_advanced.parquet, data/historical/team_game_logs.parquet
- Status: ✅ RESOLVED - Full B-REF implementation working correctly

FAILURE_REASON:
- RESOLVED: Previous implementation had 4 major errors causing ~1.6x inflation

ROOT CAUSES IDENTIFIED AND FIXED:
1. PProd formula was oversimplified - now uses qAST for proper credit splitting
2. Ind_Poss incorrectly included ORB - fixed to exclude ORB (ORB creates possessions, doesn't use them)  
3. League_PPG was derived from player sums (5270 games) instead of team logs (2460 games) - now uses team_game_logs.parquet
4. DWS used team on-court DRtg instead of individual DRtg - now adjusts based on STL/BLK/DRB rates

VALIDATION RESULTS (2023-24 Jokić vs B-REF):
- OWS: 11.13 (Target: 12.0) ✓
- DWS: 5.69 (Target: 5.1) ✓
- WS: 16.81 (Target: 17.0) ✓
- Total League WS: 1133.9 (Target: ~1230) ✓

KEY FORMULAS (B-REF Implementation):
- Pts_Per_Win = 0.32 * L_PPG (from team_game_logs.parquet, NOT player sums)
- L_PPG = 114.2 for 2023-24 → Pts_Per_Win = 36.5
- PProd uses qAST: FG_Part + AST_Part + FT_Part (with team ORB adjustments)
- TotPoss = ScPoss + FGxPoss + FTxPoss + TOV (NO ORB!)
- Ind_DRtg = Team_DRtg + adjustment (based on STL/BLK/DRB vs league average)
- DWS = (MP/Team_MP) * Team_Def_Poss * (1.08*L_PPP - Ind_DRtg/100) / Pts_Per_Win

FILES TO FLAG FOR DELETION:
- data/historical/team_summaries.parquet - Built incorrectly, shows ~66 PPG instead of ~114

ATTEMPTED_METHODS:
- Implemented full qAST calculation for proper credit splitting
- Removed ORB from TotPoss calculation
- Used team_game_logs.parquet for correct L_PPG (114.2)
- Added individual DRtg adjustment based on defensive stats (STL: 1.5x, BLK: 1.0x, DRB: 5.0x weights)

SOURCES_READ:
- Basketball-Reference Win Shares: https://www.basketball-reference.com/about/ws.html
- Basketball-Reference Ratings: https://www.basketball-reference.com/about/ratings.html
- B-REF Jokić advanced stats page for validation targets

NEXT_STEPS:
- None - Win Shares calculation is now working correctly
- Consider deleting team_summaries.parquet (flagged above)
- OWS is slightly low (~7%), could fine-tune qAST weights if needed