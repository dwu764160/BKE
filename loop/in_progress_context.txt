DO NOT CHANGE — IN-PROGRESS CONTEXT (Machine-Readable Guidance)

Purpose:
- This file captures the full working context when a model or session encounters difficulty.
- It is intended to be written to by models that are failing on a task so other models can pick up
  where they left off. Do not manually edit this file unless you are coordinating the handoff.

Required Sections (use these headings exactly; other tools rely on them):
1) CONTEXT:
	- Brief summary of the task, current working directory, and any key files or inputs in use.
2) FAILURE_REASON:
	- Short, precise description of why the current attempt failed (errors, unexpected outputs).
3) ATTEMPTED_METHODS:
	- List the strategies, commands, and code changes that were tried (bullet list).
4) SOURCES_READ:
	- Links, files, docs, and commands consulted during troubleshooting.
5) NEXT_STEPS (explicit):
	- One-line actionable items the next agent should attempt, ordered by priority.

Formatting rules for automations:
- Keep each section label (e.g., CONTEXT:) on its own line, followed by content lines.
- Use plain text only — avoid embedding binary, images, or complex markup.
- Keep entries concise; prefer short bullet lists and single-line commands for reproducibility.

Example (template):
CONTEXT:
- Task: run `src/data_compute/audit_win_shares.py`
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_profiles_advanced.parquet

FAILURE_REASON:
- ValueError: ambiguous DataFrame truth value raised at script exit check.

ATTEMPTED_METHODS:
- Added explicit None/empty check in `if __name__ == "__main__"` block.
- Re-ran script under venv; verified output.

SOURCES_READ:
- Local repo files: src/data_compute/audit_win_shares.py

NEXT_STEPS:
- If error recurs, inspect `load_data()` return value and file path accessibility.

DO NOT CHANGE this file format or the section headings; other automated agents rely on them.


---------------------------------------------CONTENTS STARTS HERE-----------------------------------------
CONTEXT:
- Task: Player Profile System Enhancement + Offensive Archetypes v4.3
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_archetypes.parquet, data/processed/archetype_embeddings.parquet, data/processed/defensive_archetypes_v2.parquet, data/tracking/{season}/shot_zones.parquet
- Status: ✅ Offensive Archetypes v4.3 COMPLETE — PnR Big absorption, harsher Interior Scorer, archetype embeddings, Inside-the-Arc rename

COMPLETED (2025-06-11):
================================================================================
Phase 3b++: Offensive Archetypes v4.3 — PnR Big Absorption + Archetype Embeddings
================================================================================

✅ OFFENSIVE ARCHETYPES v4.3 - COMPLETE
- PnR Big absorption: bigs with PROMINENT_PRROLLMAN (P50) redirected from Off-Ball Finisher / Interior Scorer → PnR Rolling Big
- Harsher Interior Scorer: rim-runner bigs (HIGH_AT_RIM + LOW_MIDRANGE + PROMINENT_PRROLLMAN) always fall through
- SKILL_FINISHING_MIN raised 0.25 → 0.40
- "Midrange Lean" subtype renamed → "Inside-the-Arc" across all files
- Distribution shift: PnR Rolling 13→40, Off-Ball Finisher 54→36, Interior Scorer 33→19
- Validated: Jarrett Allen → PnR Rolling Big, Daniel Gafford → PnR Rolling Big, Gobert/Capela stable

✅ ARCHETYPE EMBEDDINGS - COMPLETE (1,680 player-seasons, 11-dim vectors)
- compute_archetype_embedding(): softmax-weighted 11-dim vectors per player
- Uses pctile ranks + archetype-feature relevance matrix → confidence scores → α-scaled softmax
- Output: data/processed/archetype_embeddings.parquet + .csv
- Enables similarity search, clustering, and smooth archetype transitions

✅ HTML VIEWER UPDATED
- Reset All button added (clears search, dropdowns, resets sort)
- "Inside-the-Arc" subtype reflected in reason text

COMPLETED (2025-06-09):
================================================================================
Phase 3b+: Offensive Archetypes v4 — Shot Zones + Rotation Piece Elimination
================================================================================

✅ SHOT ZONE DATA FETCHER - COMPLETE
- Created src/data_fetch/fetch_shot_zones.py using LeagueDashPlayerShotLocations API
- Fetched 3 seasons: 539 + 572 + 569 players
- Computes AT_RIM_FREQ, MIDRANGE_FREQ, PAINT_FREQ, CORNER3_FREQ, AB3_FREQ
- Output: data/tracking/{season}/shot_zones.parquet

✅ OFFENSIVE ARCHETYPES v4 - COMPLETE (1,680 player-seasons, 11 archetypes)
- All-Around Scorer moved before Ballhandler in hierarchy
- All-Around scoring gate lowered P60 → P50
- Rotation Piece ELIMINATED — replaced with best-fit fallback
- New subtypes: Midrange Scorer (42 total), Rim Finisher (14 total)
- Validated: DeRozan→Midrange Scorer, Curry→Gravity Engine, KD→High Volume/Midrange, SGA→Heliocentric

✅ xRAPM COLLINEARITY FIX - COMPLETE
- Created compute_xrapm_improved.py with:
  * Collinear pair detection (503 pairs at 60%+ shared possessions)
  * Multi-year career priors (3-year lookback)
  * Doubled prior strength for collinear players (Wings/duos like Tatum/Brown)
- Validation Results (2023-24 vs NET_RATING):
  * Overall correlation: 0.582 → 0.668 (+0.087 improvement)
  * Collinear players: 0.544 → 0.645 (+0.101 improvement)  
  * MAE reduced by 44.9%
- Output: data/processed/player_xrapm_v2.csv (1,432 player-seasons)

✅ MATCHUP DATA FETCHER - COMPLETE
- Created fetch_matchup_data.py
- Fetched 414,407 matchups across 3 seasons
- Computed matchup versatility & difficulty scores

✅ DEFENSIVE ARCHETYPES v2 - COMPLETE
- Created compute_defensive_archetypes_v2.py with 5 archetypes (down from 9)
- Uses percentile-based thresholds for proper distribution
- Distribution: Rotation 43%, Off-Ball 16%, POA 16%, Rim 12%, Switchable 11%
- Validation: Gobert→Rim, AD→Rim, Wemby→Rim, Jrue→POA, Trae→Off-Ball(Liability)
- Output: data/processed/defensive_archetypes_v2.parquet (1,687 player-seasons)

✅ PLAYER ARCHETYPE VIEWER - COMPLETE
- Created app/player_archetype_viewer.py
- Generates interactive HTML viewer at app/player_archetypes.html
- Shows all players with offensive/defensive archetypes and reasoning
- Supports search/filter by name, archetype, season

CURRENT TASK:
================================================================================
Phase 3d: Player Profile System Enhancement (PLANNING ONLY)
================================================================================

CURRENT PLAYER PROFILE SYSTEM:
- Database: data/player_team_profiles.db (SQLite)
- Tables: players (686), teams (30), fetch_cache
- Player fields: player_id, full_name, team_id, position, age, height, weight, wingspan (0% filled), experience
- Fetcher: src/data_fetch/fetch_profiles.py (uses NBA API commonplayerinfo + B-Ref scraping)

PROFILE ENHANCEMENT PLAN (DO NOT START - PLANNING ONLY):
1. Add offensive archetype to player profiles
2. Add defensive archetype to player profiles  
3. Add key stats (xRAPM, BPM, WS, USG%, etc.)
4. Add salary data (need new data source)
5. Create unified player card/export format

DATA SOURCES FOR SALARY:
- ESPN player pages
- Spotrac (requires scraping)
- Basketball-Reference contracts page
- HoopsHype salary data

IMPLEMENTATION APPROACH:
- Option A: Extend SQLite schema with new columns
- Option B: Create separate parquet export with all data merged
- Option C: Both (SQLite for base, parquet for analytics)

NEXT STEPS (for next session):
1. Decide on salary data source
2. Implement salary fetcher
3. Create unified player profile export
4. Add profiles to viewer

NEXT_STEPS:
1. ✅ Defensive archetypes reduced to 5 - DONE
2. ✅ Player archetype viewer created - DONE
3. ✅ Shot zone data fetched (3 seasons) - DONE
4. ✅ Offensive archetypes v4 (Rotation Piece eliminated, Midrange Scorer/Rim Finisher) - DONE
5. ✅ Viewer updated for v4 - DONE
6. Grand Unified Model: Create compute_rapm_metrics.py (Layer 3 — RAPM + BPM prior → EPM-like metric)
7. Player Profile Enhancement: Decide on salary data source, implement fetcher, create unified export
- RESULTS: Full v4.3 validation: 0 Rotation Piece, PnR Rolling 13→40, Off-Ball Finisher 54→36, Interior Scorer 33→19, Stationary 45, Movement 26, Perimeter 17, Connector 29. Allen/Gafford→PnR Rolling Big. Archetype embeddings (1,680 player-seasons, 11-dim).
- RECENT WORK: v4.3 — PnR Big absorption (prominent P50 path), harsher Interior Scorer (SKILL_FINISHING_MIN 0.40, rim-runner check), Inside-the-Arc rename, archetype embeddings, Reset All button in viewer
- SOURCES_READ: NBA.com LeagueDashPlayerShotLocations API docs, local repo files