DO NOT CHANGE â€” IN-PROGRESS CONTEXT (Machine-Readable Guidance)

Purpose:
- This file captures the full working context when a model or session encounters difficulty.
- It is intended to be written to by models that are failing on a task so other models can pick up
  where they left off. Do not manually edit this file unless you are coordinating the handoff.

Required Sections (use these headings exactly; other tools rely on them):
1) CONTEXT:
	- Brief summary of the task, current working directory, and any key files or inputs in use.
2) FAILURE_REASON:
	- Short, precise description of why the current attempt failed (errors, unexpected outputs).
3) ATTEMPTED_METHODS:
	- List the strategies, commands, and code changes that were tried (bullet list).
4) SOURCES_READ:
	- Links, files, docs, and commands consulted during troubleshooting.
5) NEXT_STEPS (explicit):
	- One-line actionable items the next agent should attempt, ordered by priority.

Formatting rules for automations:
- Keep each section label (e.g., CONTEXT:) on its own line, followed by content lines.
- Use plain text only â€” avoid embedding binary, images, or complex markup.
- Keep entries concise; prefer short bullet lists and single-line commands for reproducibility.

Example (template):
CONTEXT:
- Task: run `src/data_compute/audit_win_shares.py`
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_profiles_advanced.parquet

FAILURE_REASON:
- ValueError: ambiguous DataFrame truth value raised at script exit check.

ATTEMPTED_METHODS:
- Added explicit None/empty check in `if __name__ == "__main__"` block.
- Re-ran script under venv; verified output.

SOURCES_READ:
- Local repo files: src/data_compute/audit_win_shares.py

NEXT_STEPS:
- If error recurs, inspect `load_data()` return value and file path accessibility.

DO NOT CHANGE this file format or the section headings; other automated agents rely on them.


---------------------------------------------CONTENTS STARTS HERE-----------------------------------------
CONTEXT:
- Task: Player Profile System Enhancement
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_archetypes.parquet, data/processed/defensive_archetypes.parquet
- Status: ðŸ”„ IN PROGRESS - Fixing defensive archetypes & building player profile system

COMPLETED (2025-02-06):
================================================================================
Phase 3b: Offensive Archetypes + xRAPM Collinearity Fix + Defensive Archetypes
================================================================================

âœ… OFFENSIVE ARCHETYPES - COMPLETE (1,680 player-seasons)
- Ball Dominant Creator, Interior Scorer, Perimeter Scorer, Off-Ball Finisher, etc.
- Validated against known player types (Lukaâ†’BDC, Stephâ†’Perimeter, Wembyâ†’Interior)
- Output: data/processed/player_archetypes.parquet

âœ… xRAPM COLLINEARITY FIX - COMPLETE
- Created compute_xrapm_improved.py with:
  * Collinear pair detection (503 pairs at 60%+ shared possessions)
  * Multi-year career priors (3-year lookback)
  * Doubled prior strength for collinear players (Wings/duos like Tatum/Brown)
- Validation Results (2023-24 vs NET_RATING):
  * Overall correlation: 0.582 â†’ 0.668 (+0.087 improvement)
  * Collinear players: 0.544 â†’ 0.645 (+0.101 improvement)  
  * MAE reduced by 44.9%
- Output: data/processed/player_xrapm_v2.csv (1,432 player-seasons)

âœ… MATCHUP DATA FETCHER - COMPLETE
- Created fetch_matchup_data.py
- Fetched 414,407 matchups across 3 seasons
- Computed matchup versatility & difficulty scores

âœ… DEFENSIVE ARCHETYPES v2 - COMPLETE
- Created compute_defensive_archetypes_v2.py with 5 archetypes (down from 9)
- Uses percentile-based thresholds for proper distribution
- Distribution: Rotation 43%, Off-Ball 16%, POA 16%, Rim 12%, Switchable 11%
- Validation: Gobertâ†’Rim, ADâ†’Rim, Wembyâ†’Rim, Jrueâ†’POA, Traeâ†’Off-Ball(Liability)
- Output: data/processed/defensive_archetypes_v2.parquet (1,687 player-seasons)

âœ… PLAYER ARCHETYPE VIEWER - COMPLETE
- Created app/player_archetype_viewer.py
- Generates interactive HTML viewer at app/player_archetypes.html
- Shows all players with offensive/defensive archetypes and reasoning
- Supports search/filter by name, archetype, season

CURRENT TASK:
================================================================================
Phase 3d: Player Profile System Enhancement (PLANNING ONLY)
================================================================================

CURRENT PLAYER PROFILE SYSTEM:
- Database: data/player_team_profiles.db (SQLite)
- Tables: players (686), teams (30), fetch_cache
- Player fields: player_id, full_name, team_id, position, age, height, weight, wingspan (0% filled), experience
- Fetcher: src/data_fetch/fetch_profiles.py (uses NBA API commonplayerinfo + B-Ref scraping)

PROFILE ENHANCEMENT PLAN (DO NOT START - PLANNING ONLY):
1. Add offensive archetype to player profiles
2. Add defensive archetype to player profiles  
3. Add key stats (xRAPM, BPM, WS, USG%, etc.)
4. Add salary data (need new data source)
5. Create unified player card/export format

DATA SOURCES FOR SALARY:
- ESPN player pages
- Spotrac (requires scraping)
- Basketball-Reference contracts page
- HoopsHype salary data

IMPLEMENTATION APPROACH:
- Option A: Extend SQLite schema with new columns
- Option B: Create separate parquet export with all data merged
- Option C: Both (SQLite for base, parquet for analytics)

NEXT STEPS (for next session):
1. Decide on salary data source
2. Implement salary fetcher
3. Create unified player profile export
4. Add profiles to viewer

NEXT_STEPS:
1. âœ… Defensive archetypes reduced to 5 - DONE
2. âœ… Player archetype viewer created - DONE
3. âœ… Player profile system found (SQLite DB) - DONE
4. Plan created for profile enhancement - DONE
5. Session complete - profile enhancement to be done in next session
- RESULTS: Full validation harness run; reported MAEs: WS 0.54, OWS 0.66, DWS 0.61, BPM 0.67, VORP 0.29 (PASS).
- RECENT FIXES: name-matching robustness for accented player names (e.g., JokiÄ‡); minutes-weighted `team_avg_net_rtg` computed from player on-court NET_RTG when team summary source is unreliable.
- ATTEMPTED_METHODS: refactor `compute_linear_metrics.py` to compute `team_avg_net_rtg`, add TEAM_NET_SCALE/IND_NET_SCALE params, increase VERY_LOW_MIN_PENALTY, add AST-based big bonus and guard playmaker follow-up notes.
- SOURCES_READ: reference/BPM_trends.txt (this repo), Basketball-Reference BPM & Win Shares docs (for formulas), local validation harness `tests/validate_advanced_metrics.py`.
- NEXT_STEPS (explicit):
  1) Implement RAPM/Adjusted Plus-Minus pipeline (`src/data_compute/compute_rapm.py`) using multi-season regularized regression and set as prior for downstream EPM/RAPM-based metrics. (High priority)
  2) Add targeted elite-guard playmaker bonus (Priority 2 in BPM_trends) and re-run validation to measure impact (medium priority).
  3) Add additional edge-case players to validation harness (GP2, Curry, Gafford, Mark Williams, Haliburton) and rerun to confirm stability (low priority).