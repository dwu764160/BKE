DO NOT CHANGE — IN-PROGRESS CONTEXT (Machine-Readable Guidance)

Purpose:
- This file captures the full working context when a model or session encounters difficulty.
- It is intended to be written to by models that are failing on a task so other models can pick up
  where they left off. Do not manually edit this file unless you are coordinating the handoff.

Required Sections (use these headings exactly; other tools rely on them):
1) CONTEXT:
	- Brief summary of the task, current working directory, and any key files or inputs in use.
2) FAILURE_REASON:
	- Short, precise description of why the current attempt failed (errors, unexpected outputs).
3) ATTEMPTED_METHODS:
	- List the strategies, commands, and code changes that were tried (bullet list).
4) SOURCES_READ:
	- Links, files, docs, and commands consulted during troubleshooting.
5) NEXT_STEPS (explicit):
	- One-line actionable items the next agent should attempt, ordered by priority.

Formatting rules for automations:
- Keep each section label (e.g., CONTEXT:) on its own line, followed by content lines.
- Use plain text only — avoid embedding binary, images, or complex markup.
- Keep entries concise; prefer short bullet lists and single-line commands for reproducibility.

Example (template):
CONTEXT:
- Task: run `src/data_compute/audit_win_shares.py`
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_profiles_advanced.parquet

FAILURE_REASON:
- ValueError: ambiguous DataFrame truth value raised at script exit check.

ATTEMPTED_METHODS:
- Added explicit None/empty check in `if __name__ == "__main__"` block.
- Re-ran script under venv; verified output.

SOURCES_READ:
- Local repo files: src/data_compute/audit_win_shares.py

NEXT_STEPS:
- If error recurs, inspect `load_data()` return value and file path accessibility.

DO NOT CHANGE this file format or the section headings; other automated agents rely on them.


---------------------------------------------CONTENTS STARTS HERE-----------------------------------------
CONTEXT:
- Task: Win Shares calculation in `src/data_compute/compute_linear_metrics.py`
- Env: Linux, venv at `.venv/`, Python 3.10
- Key files: data/processed/player_profiles_advanced.parquet, data/historical/team_game_logs.parquet
- Status: ✅ RESOLVED - Full B-REF implementation working correctly

FAILURE_REASON:
- RESOLVED: Previous implementation had 4 major errors causing ~1.6x inflation

ROOT CAUSES IDENTIFIED AND FIXED:
1. PProd formula was oversimplified - now uses qAST for proper credit splitting
2. Ind_Poss incorrectly included ORB - fixed to exclude ORB (ORB creates possessions, doesn't use them)  
3. League_PPG was derived from player sums (5270 games) instead of team logs (2460 games) - now uses team_game_logs.parquet
4. DWS used team on-court DRtg instead of individual DRtg - now uses proper Stops-based B-REF formula

VALIDATION RESULTS (2023-24 vs B-REF):
| Player           | OWS_Calc | OWS_REF | OWS_Err | DWS_Calc | DWS_REF | DWS_Err | WS_Err |
|------------------|----------|---------|---------|----------|---------|---------|--------|
| Nikola Jokić     | 11.13    | 12.0    | -7.3%   | 5.90     | 5.1     | +15.7%  | +0.2%  |
| Tyrese Haliburton| 7.01     | 7.6     | -7.7%   | 2.20     | 1.5     | +46.9%  | +2.4%  |

League Totals: 2023-24 WS = 1295 (Target: ~1230, +5% error)

KEY FORMULAS (Full B-REF Implementation):

OWS:
- qAST = min_pct * (1.14 * (Team_AST - AST) / Team_FGM) + part2_ratio * (1 - min_pct)
- PProd_FG_Part = 2 * (FGM + 0.5 * 3PM) * (1 - 0.5 * pts_per_fga * qAST)
- PProd_AST_Part = 2 * team_fg_factor * 0.5 * (team_other_pts / 2 / team_other_fga) * AST
- PProd = (FG_Part + AST_Part + FTM) * (1 - ORB_adj) + ORB_Part
- TotPoss = ScPoss + FGxPoss + FTxPoss + TOV (NO ORB!)
- OWS = (PProd - 0.92 * L_PPP * TotPoss) / Pts_Per_Win

DWS (Stops-based B-REF Formula):
- FMwt = (DFG% * (1-DOR%)) / (DFG% * (1-DOR%) + (1-DFG%) * DOR%)  ≈ 0.73
- Stops1 = STL + BLK * FMwt * (1 - 1.07*DOR%) + DRB * (1 - FMwt)
- Stops2 = (missed_non_blk_rate * FMwt * (1-1.07*DOR%) + non_stl_tov_rate) * MP
- Stop% = (Stops * 2.4) / MP  (typically 40-60% for starters)
- Ind_DRtg = Team_DRtg + 0.2 * (100 * D_Pts_per_ScPoss * (1 - Stop%) - Team_DRtg)
- DWS = (MP/Team_MP) * Team_Def_Poss * (1.08*L_PPP - Ind_DRtg/100) / Pts_Per_Win

REMAINING KNOWN ISSUES:
1. OWS ~7% low - Using league-average team stats instead of player's actual team
2. DWS variance ~35-47% - Haliburton's DWS especially variable
   - 2022-23: -35.6% error, 2023-24: +46.9% error

FILES TO FLAG FOR DELETION:
- data/historical/team_summaries.parquet - Built incorrectly, shows ~66 PPG instead of ~114

ATTEMPTED_METHODS:
- Implemented full qAST calculation for proper credit splitting
- Removed ORB from TotPoss calculation
- Used team_game_logs.parquet for correct L_PPG (114.2)
- Implemented proper B-REF Stops-based DRtg formula with 0.2 team-blend coefficient
- Fixed Stop% calculation: Stop% = Stops * 2.4 / MP

SOURCES_READ:
- Basketball-Reference Win Shares: https://www.basketball-reference.com/about/ws.html
- Basketball-Reference Ratings: https://www.basketball-reference.com/about/ratings.html  
- B-REF Jokić and Haliburton advanced stats pages for validation targets

NEXT_STEPS:
- None - Win Shares calculation is now working correctly (Jokić WS error: +0.2%)
- Future improvement: Use player's actual team stats instead of league averages
- Consider deleting team_summaries.parquet (flagged above)