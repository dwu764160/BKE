// Flow diagram of repository Python scripts and data artifacts
// Generated by assistant â€” maps inputs/outputs and key interactions
digraph repo_flow {
  rankdir=LR;
  node [shape=box, fontname="Helvetica", fontsize=10];

  // Data stores
  data_historical [label="data/historical/*\n(parquets, caches)", shape=folder];
  data_root [label="data/*\n(parsed outputs, DB)", shape=folder];

  // Fetchers cluster
  subgraph cluster_fetch {
    label="Data Fetch / Ingest";
    style=rounded;
    fetch_historical [label="fetch_historical_data.py\n(nba_api)\n-> team_game_logs.parquet, player logs"];
    fetch_pbp_cdn [label="CDN_pbp_fetch.py\n(fast CDN)\nreads: team_game_logs.parquet\n-> pbp_cache/pbp_GAME_ID.parquet\n-> play_by_play_SEASON.parquet"];
    fetch_pbp_playwright [label="fetch_play_by_play.py\n(playwright Next.js DOM fallback)\nreads: team_game_logs.parquet\n-> pbp_cache/pbp_GAME_ID.parquet\n-> play_by_play_SEASON.parquet"];
    capture_headers [label="capture_nba_headers.py\n-> data/nba_headers.json"];
    bootstrap_session [label="bootstrap_nba_session.py\n-> data/nba_session.json"];
  }

  // Derivation cluster
  subgraph cluster_derive {
    label="Derive / Combine";
    style=rounded;
    derive_team_logs [label="derive_team_game_logs.py\nreads: play_by_play_*.parquet\n-> data/historical/team_game_logs.parquet"];
    summarize_team_logs [label="summarize_team_logs.py\nreads: team_game_logs.parquet\n-> team_summaries.parquet, team_game_details.parquet"];
  }

  // Normalize / Parser
  subgraph cluster_normalize {
    label="Normalization";
    style=rounded;
    pbp_parser [label="pbp_parser.py\n(core row normalizer)\nused by run_normalization.py", shape=component];
    run_normalize [label="run_normalization.py\nreads: play_by_play_*.parquet\n-> pbp_normalized_SEASON.parquet"];
  }

  // Features
  subgraph cluster_features {
    label="Feature Engineering";
    style=rounded;
    derive_lineups [label="derive_lineups.py\nreads: pbp_normalized_SEASON.parquet\n-> pbp_with_lineups_SEASON.parquet"];
    compute_schedule [label="compute_rest_home_back2back.py\nreads: team_game_logs.parquet\n-> feature_schedule_context.parquet"];
  }

  // Advanced compute
  subgraph cluster_compute {
    label="Advanced Metrics";
    style=rounded;
    compute_local [label="compute_local_metrics.py\nreads: player_game_logs.parquet (or historical variants)\nreads: team_game_logs.parquet (optional)\n-> advanced_local_metrics.parquet"];
  }

  // Profiles / DB
  subgraph cluster_profiles {
    label="Profiles & DB";
    style=rounded;
    fetch_profiles [label="fetch_profiles.py\n(commonplayerinfo + scrapers)\n-> upserts into player_team_profiles.db"];
    fetch_players [label="fetch_players.py\n(drives fetch_profiles for many PLAYER_IDs)\n-> player_team_profiles.db"];
    fetch_teams [label="fetch_teams.py\n(fetch team metadata)\n-> player_team_profiles.db"];
    db_utils [label="db_utils.py\n(create_tables, cache helpers)", shape=component];
  }

  // Tests / validators
  tests [label="tests/*.py\n(validation scripts)", shape=note];

  // Data artifacts as nodes
  team_game_logs [label="data/historical/team_game_logs.parquet", shape=invhouse];
  play_by_play [label="data/historical/play_by_play_SEASON.parquet", shape=invhouse];
  pbp_cache [label="data/historical/pbp_cache/pbp_GAME_ID.parquet", shape=folder];
  pbp_normalized [label="data/historical/pbp_normalized_SEASON.parquet", shape=invhouse];
  pbp_with_lineups [label="data/historical/pbp_with_lineups_SEASON.parquet", shape=invhouse];
  feature_schedule [label="data/historical/feature_schedule_context.parquet", shape=invhouse];
  team_summaries [label="data/historical/team_summaries.parquet/csv", shape=invhouse];
  team_game_details [label="data/historical/team_game_details.parquet/csv", shape=invhouse];
  player_team_db [label="data/player_team_profiles.db", shape=cylinder];
  advanced_metrics [label="data/advanced_local_metrics.parquet", shape=invhouse];

  // Edges: fetchers -> artifacts
  fetch_historical -> team_game_logs [label="writes / updates", color=green];
  fetch_historical -> play_by_play [label="(sometimes) writes player/team logs", style=dashed];

  fetch_pbp_cdn -> pbp_cache [label="per-game parquets", color=blue];
  fetch_pbp_playwright -> pbp_cache [label="per-game parquets (DOM)", color=blue];
  fetch_pbp_cdn -> play_by_play [label="concat season files", color=blue];
  fetch_pbp_playwright -> play_by_play [label="concat season files", color=blue];

  // Derive step links
  play_by_play -> derive_team_logs [arrowhead=normal];
  derive_team_logs -> team_game_logs [label="writes master team_game_logs.parquet", color=black];
  team_game_logs -> summarize_team_logs [arrowhead=normal];
  summarize_team_logs -> team_summaries [label="writes summaries & details", color=black];
  summarize_team_logs -> team_game_details [style=dashed];

  // Normalization links
  play_by_play -> run_normalize [label="input seasons", color=purple];
  run_normalize -> pbp_normalized [label="normalized PBP", color=purple];
  pbp_parser -> run_normalize [label="used by", style=dotted];

  // Features links
  pbp_normalized -> derive_lineups [label="input for lineup inference", color=orange];
  derive_lineups -> pbp_with_lineups [label="writes pbp_with_lineups", color=orange];
  team_game_logs -> compute_schedule [label="input for schedule features", color=orange];
  compute_schedule -> feature_schedule [label="writes schedule/context features", color=orange];

  // Advanced metrics
  advanced_metrics -> compute_local [style=invis];
  player_team_db -> fetch_profiles [style=invis];
  // compute_local reads player logs and team logs
  compute_local -> advanced_metrics [label="writes advanced metrics", color=red];
  // Represent compute_local inputs
  play_by_play -> compute_local [label="(indirect) via player_game_logs", style=dashed];
  team_game_logs -> compute_local [label="optional input", style=dashed];

  // Profiles & DB links
  fetch_profiles -> player_team_db [label="upsert player rows", color=green];
  fetch_players -> fetch_profiles [label="drives individual profile fetches", style=dotted];
  fetch_teams -> player_team_db [label="upsert teams", color=green];
  db_utils -> fetch_profiles [label="helper functions", style=dotted];

  // Tests
  tests -> pbp_normalized [label="validate normalized PBP", style=dashed];

  // Grouping placement hints
  { rank=same; fetch_historical; fetch_pbp_cdn; fetch_pbp_playwright }
  { rank=same; derive_team_logs; run_normalize }
  { rank=same; derive_lineups; compute_schedule }
}
